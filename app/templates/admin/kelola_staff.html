<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Dashboard Staff</title>
    <link rel="stylesheet" href="{{ url_for('static', filename = 'src/css/input.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename = 'src/css/output.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.tailwindcss.css">
</head>

<body class="bg-white poppins-regular">

    <div class="flex h-screen">
        <!-- Sidebar -->
        {% include 'UI-components/sidebar.html' %}
        <!-- End Sidebar -->

        <main class="flex-1 h-screen overflow-y-auto bg-white p-10">

            <!-- Top bar -->
            {% include 'UI-components/topbar.html' %}
            <!-- End Top bar -->

            <div>
                <div id="global-alert" class="hidden mb-6 p-4 rounded-lg text-sm"></div>
                <div class="flex justify-end items-end mb-4">
                   <button onclick="openStaffModal()" class="text-white bg-[#000264] py-2 px-4 rounded-lg">Tambah Staff</button>
                </div>
                <table id="tableKelolaStaff" class="py-8">
                    <thead class="table-dark">
                        <tr>
                            <th>No</th>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>Alamat</th>
                            <th>Nomor Telepon</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if staff_list and staff_list|length > 0 %}
                            {% for s in staff_list %}
                                <tr>
                                    <td class="py-2 px-3">{{ loop.index }}</td>
                                    <td class="py-2 px-3">{{ s[1] }}</td>
                                    <td class="py-2 px-3">{{ s[2] }}</td>
                                    <td class="py-2 px-3">{{ s[3] or '-' }}</td>
                                    <td class="py-2 px-3">{{ s[4] or '-' }}</td>
                                    <td class="py-2 px-3">
                                        <!-- contoh tombol aksi: edit / hapus -->
                                        <a href="javascript:void(0)"
                                           class="text-green-600 bg-green-50 p-1 rounded-sm hover:bg-green-100 transition-colors btn-edit-staff"
                                           data-id="{{ s[0] }}"
                                           data-nama="{{ s[1]|e }}"
                                           data-email="{{ s[2]|e }}"
                                           data-alamat="{{ s[3]|e }}"
                                           data-nomor="{{ s[4]|e }}">
                                            Edit
                                        </a>
                                        <a href="javascript:void(0)" data-id="{{ s[0] }}"
                                           class="text-red-600 ms-3 bg-red-50 p-1 rounded-sm hover:bg-red-100 btn-delete-staff">Hapus</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="py-4 px-3 text-center text-gray-500">Belum ada data staff.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

        </main>

        <button
            class="fixed bottom-6 right-6 w-12 h-12 bg-red-500 text-white rounded-full flex items-center justify-center text-2xl font-bold shadow-lg hover:bg-red-600">
            ?
        </button>
    </div>

<div id="staff-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
  <div class="bg-white rounded-2xl w-full max-w-md p-6 sm:p-8 shadow-xl relative">
    <div class="flex items-center gap-4 mb-6">
      <img src="{{ url_for('static', filename='src/images/logo-brand.png') }}"
           alt="Delis Park System Logo" class="h-16">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Delis Park System</h3>
        <p class="text-sm text-gray-500">Tambah Staff Baru</p>
      </div>
    </div>

    <button type="button" onclick="closeStaffModal()"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>

    <div id="staff-alert" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium text-gray-700">Nama</label>
        <input id="staff-nama" type="text"
               class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#000264]"
               placeholder="Nama lengkap">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="staff-email" type="email"
               class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#000264]"
               placeholder="email@contoh.com">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Nomor Telepon</label>
        <input id="staff-nomor" type="text"
               class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#000264]"
               placeholder="0812xxxx">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Alamat</label>
        <textarea id="staff-alamat" rows="3"
                  class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#000264]"
                  placeholder="Alamat rumah"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Password</label>
        <input id="staff-password" type="password"
               class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#000264]"
               placeholder="Password">
      </div>

      <div class="mt-4 flex flex-col gap-3">
        <button id="btn-add-staff"
                class="w-full bg-[#000264] text-white py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-colors">
          Simpan
        </button>
        
        </button>
      </div>
    </div>
  </div>
</div>

<div id="staff-edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
  <div class="bg-white rounded-2xl w-full max-w-md p-6 sm:p-8 shadow-xl relative">
    <button type="button" onclick="closeStaffEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Edit Staff</h3>
    <div id="staff-edit-alert" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

    <input type="hidden" id="staff-edit-id" />

    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium text-gray-700">Nama</label>
        <input id="staff-edit-nama" type="text" class="w-full border rounded-lg p-3 bg-gray-50" placeholder="Nama lengkap">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="staff-edit-email" type="email" class="w-full border rounded-lg p-3 bg-gray-50" placeholder="email@contoh.com">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Nomor Telepon</label>
        <input id="staff-edit-nomor" type="text" class="w-full border rounded-lg p-3 bg-gray-50" placeholder="0812xxxx">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Alamat</label>
        <textarea id="staff-edit-alamat" rows="3" class="w-full border rounded-lg p-3 bg-gray-50" placeholder="Alamat"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Password Baru (kosong = tidak diubah)</label>
        <input id="staff-edit-password" type="password" class="w-full border rounded-lg p-3 bg-gray-50" placeholder="Password baru">
      </div>

      <div class="mt-4 flex flex-col gap-3">
        <button id="btn-update-staff" class="w-full bg-[#000264] text-white py-3 rounded-lg font-semibold">Simpan Perubahan</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.tailwindcss.com/"></script>
<script src="https://cdn.datatables.net/2.3.4/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.3.4/js/dataTables.tailwindcss.js"></script>
<script>
    new DataTable('#tableKelolaStaff');

    function openStaffModal(){ const m=document.getElementById('staff-modal'); m.classList.remove('hidden'); m.classList.add('flex'); }
  function closeStaffModal(){ const m=document.getElementById('staff-modal'); m.classList.add('hidden'); m.classList.remove('flex'); }

  function showStaffAlert(msg, cls){
    const el = document.getElementById('staff-alert');
    if(!el) return;
    el.textContent = msg;
    el.className = (cls ? cls + ' ' : '') + 'mb-4 p-3 rounded-lg text-sm';
    el.classList.remove('hidden');
  }

  document.getElementById('btn-add-staff').addEventListener('click', function(){
    const nama = document.getElementById('staff-nama').value.trim();
    const email = document.getElementById('staff-email').value.trim();
    const nomor = document.getElementById('staff-nomor').value.trim();
    const alamat = document.getElementById('staff-alamat').value.trim();
    const password = document.getElementById('staff-password').value;

    if(!nama || !email || !password){
      showStaffAlert('Nama, email dan password wajib diisi', 'bg-red-100 text-red-700');
      return;
    }

    fetch("{{ url_for('admin_bp.kelola_staff_add') }}", {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ nama: nama, email: email, nomor_telepon: nomor, alamat: alamat, password: password })
    })
    .then(async res => {
      const text = await res.text();
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch(e){ console.error('Invalid JSON', text); }
      if(!res.ok){
        const msg = (json && json.message) || `Server error ${res.status}`;
        showStaffAlert(msg, 'bg-red-100 text-red-700');
        throw new Error(msg);
      }
      if(json && json.success){
        // reload supaya list staff terupdate (atau bisa tambahkan row dinamis)
        sessionStorage.setItem('flashMessage', json.message || 'Staff ditambahkan');
        location.reload();
      } else {
        showStaffAlert((json && json.message) || 'Gagal menambahkan', 'bg-red-100 text-red-700');
      }
    })
    .catch(err => {
      console.error('Fetch error', err);
      showStaffAlert('Terjadi kesalahan koneksi', 'bg-red-100 text-red-700');
    });
  });

  (function(){
        const flashMessage = sessionStorage.getItem('flashMessage');
        if (flashMessage) {
            const alertBox = document.getElementById('global-alert');
            if (alertBox) {
                alertBox.textContent = flashMessage;
                alertBox.className = 'mb-6 p-4 rounded-lg text-sm bg-green-100 text-green-700';
                alertBox.classList.remove('hidden');
                
                sessionStorage.removeItem('flashMessage');
            }
        }
    })();

    function openStaffEditModal(){ const m=document.getElementById('staff-edit-modal'); m.classList.remove('hidden'); m.classList.add('flex'); }
  function closeStaffEditModal(){ const m=document.getElementById('staff-edit-modal'); m.classList.add('hidden'); m.classList.remove('flex'); }

  function showStaffEditAlert(msg, cls){
    const el = document.getElementById('staff-edit-alert');
    if(!el) return;
    el.textContent = msg || '';
    const base = 'mb-4 p-3 rounded-lg text-sm';
    el.className = (cls ? cls + ' ' : '') + base;
    el.classList.remove('hidden');
  }

  // handler klik Edit -> isi modal
  document.querySelectorAll('.btn-edit-staff').forEach(btn => {
    btn.addEventListener('click', function(){
      const id = this.dataset.id;
      document.getElementById('staff-edit-id').value = id;
      document.getElementById('staff-edit-nama').value = this.dataset.nama || '';
      document.getElementById('staff-edit-email').value = this.dataset.email || '';
      document.getElementById('staff-edit-nomor').value = this.dataset.nomor || '';
      document.getElementById('staff-edit-alamat').value = this.dataset.alamat || '';
      document.getElementById('staff-edit-password').value = '';
      // hide any previous alert
      const a = document.getElementById('staff-edit-alert');
      if(a) a.classList.add('hidden');
      openStaffEditModal();
    });
  });

  // submit update
  document.getElementById('btn-update-staff').addEventListener('click', function(){
    const id = document.getElementById('staff-edit-id').value;
    const nama = document.getElementById('staff-edit-nama').value.trim();
    const email = document.getElementById('staff-edit-email').value.trim();
    const nomor = document.getElementById('staff-edit-nomor').value.trim();
    const alamat = document.getElementById('staff-edit-alamat').value.trim();
    const password = document.getElementById('staff-edit-password').value;

    if(!id || !nama || !email){
      showStaffEditAlert('ID, nama dan email wajib', 'bg-red-100 text-red-700');
      return;
    }

    fetch("{{ url_for('admin_bp.kelola_staff_update') }}", {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ id: id, nama: nama, email: email, nomor_telepon: nomor, alamat: alamat, password: password })
    })
    .then(async res => {
      const text = await res.text();
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch(e){ console.error('Invalid JSON', text); }
      if(!res.ok){
        const msg = (json && json.message) || `Server error ${res.status}`;
        showStaffEditAlert(msg, 'bg-red-100 text-red-700');
        throw new Error(msg);
      }
      if(json && json.success){
        sessionStorage.setItem('flashMessage', json.message || 'Perubahan tersimpan');
        location.reload();
      } else {
        showStaffEditAlert((json && json.message) || 'Gagal menyimpan', 'bg-red-100 text-red-700');
      }
    }).catch(err => {
      console.error('Fetch error', err);
      showStaffEditAlert('Terjadi kesalahan koneksi', 'bg-red-100 text-red-700');
    });
  });

  // delete handler (konfirmasi)
  document.querySelectorAll('.btn-delete-staff').forEach(btn => {
    btn.addEventListener('click', function(){
      const id = this.dataset.id;
      if(!confirm('Hapus staff ini? Tindakan tidak bisa dibatalkan.')) return;
      fetch("{{ url_for('admin_bp.kelola_staff_delete') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id: id })
      })
      .then(async res => {
        const text = await res.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch(e){ console.error('Invalid JSON', text); }
        if(!res.ok){
          const msg = (json && json.message) || `Server error ${res.status}`;
          alert(msg);
          throw new Error(msg);
        }
        if(json && json.success){
          sessionStorage.setItem('flashMessage', json.message || 'Staff dihapus');
          location.reload();
        } else {
          alert((json && json.message) || 'Gagal menghapus');
        }
      }).catch(err => {
        console.error('Fetch error', err);
        alert('Terjadi kesalahan koneksi');
      });
    });
  });
</script>
</body>


</html>
